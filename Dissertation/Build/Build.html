<!DOCTYPE html>
<html>

<head>
  <title>WebGL 3D Model Viewer</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <!-- GUI -->
  <div id="SideBar">
    <span class="slide">
      <a href="#" onclick="openSlideMenu()">
        <i id="Hamburger">â‰¡</i>
      </a>
    </span>

    <div id="SettingsMenu" class="nav">
      <ul class="SideBarUl">
        <li href="#" class="close">
          <div>
          <h1>3D Level Design Tool
            <h2>Jack Smerdon</h2>
          </h1>
        </div>
          <a = href="#" onclick="closeSlideMenu()">X</a></li>
        <!-- Camera Settings-->
        <li onclick="this.classList.toggle('clicked')"class="camera"><a href="#">Camera</a>
          <ul class="cameraDark">
            <li><a>Auto Rotate
              <label class="switch">
                <input type="checkbox"  onclick="toggleAutoRotate()">
                <span class="slider round"></span>
              </label></a></li>
              <li><a href="#" onclick="toggleCamReset()">Reset</a></li>
            </ul>
        </li>

        <!-- Model Settings -->
        <li onclick="this.classList.toggle('clicked')" class="models"><a  href="#">Models</a>
          <ul class="modelsDark">
            <li><a href="#">Load New Model:</a>
              <ul>
                <a>Model:</a>
                <input type="file" id="NewModel" accept=".obj">
                <a>Material:</a>
                <input type="file" id="NewMaterial" accept=".mtl">

                <!-- Not Yet Implemented
                <a>Texture:</a>
                <input type="file" id="NewTexture" accept="image/*">
                -->

                <a href='#' onClick="loadNewModel()">Load Model</a>
              </ul>
            </li>
            <li><a>Models in Scene:</a>
              <ul id="ModelListTop">
                <li id="ModelListBottom"></li>
              </ul>
            </li>
          </ul>
        </li>

        <!-- Lighting Settings -->
        <li onclick="this.classList.toggle('clicked')" class="lighting"><a href="#">Lighting</a>
          <ul class="lightingDark">
            <li><a>Existing Lights:</a>
              <ul id="LightListTop">
              <ul id="LightListBottom"></ul>
            </ul>
            <li ><a href="#" onclick="addLight()">Spawn Light</a></li>
          </ul>
        </li>

        <!-- Rendering Settings -->
        <li onclick="this.classList.toggle('clicked')" class="rendering"><a href="#">Rendering</a>
          <ul class="renderingDark">
            <li><a href="#" onclick=""></a></li>
          </ul>
        </li>

        <!-- Skybox Settings -->
        <li onclick="this.classList.toggle('clicked')" class="skybox"><a href="#">Skybox</a>
          <ul class="skyboxDark">
            <li><a>Textures:</a>
              <ul>
                <a>Front:</a>
                <input type="file" id="NewFrontIMG" accept="image/*">

                <a>Back:</a>
                <input type="file" id="NewBackIMG" accept="image/*">

                <a>Up:</a>
                <input type="file" id="NewUpIMG" accept="image/*">

                <a>Down:</a>
                <input type="file" id="NewDownIMG" accept="image/*">

                <a>Right:</a>
                <input type="file" id="NewRightIMG" accept="image/*">

                <a>Left:</a>
                <input type="file" id="NewLeftIMG" accept="image/*">
                <a href="#" onclick="updateSkybox()">Reload</a>
              </ul>
            </li>

            <li><a>Help:</a>
              <ul>
                <a href="#" onclick="defaultSkybox()">Reset to Default</a>
                <a href="#" onclick="helperSkybox()">Helper Textures</a>
              </ul>
            </li>
          </ul>
        </li>

        <!-- Scene Settings -->
        <li onclick="this.classList.toggle('clicked')" class="scene"><a href="#">Scene</a>
          <ul class="sceneDark">
            <li><a>Settings:</a>
              <ul>
                <a>Some Setting</a>
                <a>Some Setting</a>
                <a>Some Setting</a>
              </ul>
            </li>
            <li><a>Sample Scenes:</a>
              <ul>
                <a>Sample 1</a>
                <a>Sample 2</a>
                <a>Sample 3</a>
              </ul>
            </li>
            <li>
                <a>Files:</a>
                  <ul>
                  <a>Load Scene:</a>
                  <input type="file" id="Load Scene" accept=".gltf">
                  <a>Save Scene</a>
              </ul>
            </li>
          </ul>

        </li>

        <!-- Picker -->
        <li>
          <ul class="Focus">
          <div class="colorpicker" style="display:none">
            <a>Light Settings</a>
            <canvas id="picker"></canvas>
              <div class="controls">
                <div><label>Name</label> <input type="text" id="lightName" /></div>
                <div><label>Type</label> <input type="text" id="lightType" /></div>
                <div><label>R</label> <input type="text" id="rVal" /></div>
                <div><label>G</label> <input type="text" id="gVal" /></div>
                <div><label>B</label> <input type="text" id="bVal" /></div>
                <div><label>HEX</label> <input type="text" id="hexVal" /></div>
                <li><a href="#" onclick="">Show Helper</a></li>
                <li><a href="#" onclick="defaultLighting()">Reset to Default</a></li>
              </div>
            </div>
          </ul>
        </li>

      </ul>
    </div>
  </div>

  <!-- Includes -->
  <script src="Imports/three.js"></script>
  <script src="Imports/Detector.js"></script>
  <script src="Imports/OrbitControls.js"></script>
  <script src="Imports/OBJLoader.js"></script>
  <script src="Imports/MTLLoader.js"></script>
  <script src="Imports/jquery.js"></script>
  <!-- <script src="Imports/ColourPicker.js"></script> -->

  <!-- Program -->
  <script>

  //Displays message to the user if webGL is not supported in the browser.
  if (!Detector.webgl) {
    Detector.addGetWebGLMessage();
  }

  //Structs
  function ModelObject (modelIn, materialIn, wireframeIn) {
    this.Model = modelIn;
    this.Material = materialIn;
    //this.Texture = textureIn;
    this.Wireframe = wireframeIn;
  }

  //Globals
  var container = document.createElement('div');
  document.body.appendChild(container);

  //Clean Variables
  var Lights = [];
  var LightHelpers = [];
  var Models = [];
  var Skybox;



  //Old
  var camera, controls, renderer;
  var shadowSwitch = true;
  var ambientLight;
  var pointLights = [];

  var gridHelper, plane;


  var planeSize;

  var model, wireframeModel, cloneModel;

  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;

  var scene = new THREE.Scene();

  init();
  animate();

  function toRadians (angle) {
    return angle * (Math.PI / 180);
  }

  function drawPlane(x,y) {
    var planeGeometry = new THREE.PlaneGeometry( x, y, 1, 1 );
    var planeMaterial = new THREE.MeshPhongMaterial( {color: 0x707070, side: THREE.DoubleSide} );
    plane = new THREE.Mesh( planeGeometry, planeMaterial );
    plane.rotation.x = toRadians(90);
    plane.receiveShadow = true;
    scene.add( plane );
    planeSize = new THREE.Box3().setFromObject( plane );

  }

  function setupCamera(x, y, z, near, far) {
    /* Camera */
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, near, far);
    camera.position.x = x;
    camera.position.y = y;
    camera.position.z = z;

    /* Renderer */
    renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(new THREE.Color("hsl(0, 0%, 10%)"));

    container.appendChild(renderer.domElement);

    /* Controls */
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.25;
    controls.enableZoom = true;
    controls.maxDistance = 1500;
    controls.minDistance = 3;
    controls.autoRotate = false;
    controls.autoRotateSpeed = -0.5;
    controls.maxPolarAngle = 1.5;
  }

  function defaultSkybox() {
    scene.remove(Skybox);
    var skyboxGeometry = new THREE.CubeGeometry(10000, 10000, 10000);
    var skyboxMaterials =
    [
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Front.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Back.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Up.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Down.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Right.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Left.png"), side: THREE.DoubleSide})
    ];

    Skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterials);
    scene.add (Skybox);
  }

  function helperSkybox() {
    scene.remove(Skybox);
    var skyboxGeometry = new THREE.CubeGeometry(10000, 10000, 10000);
    var skyboxMaterials =
    [
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Test/Front.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Test/Back.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Test/Up.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Test/Down.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Test/Right.png"), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load("Assets/Skybox/Test/Left.png"), side: THREE.DoubleSide})
    ];

    Skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterials);
    scene.add (Skybox);
  }

  function drawGrid(size, divs){
    /* Grid */
    var gridSize = size;
    var divisions = divs;

    gridHelper = new THREE.GridHelper(gridSize, divisions);
  }

  function loadDefaultModel() {
    var mtlLoader = new THREE.MTLLoader();
    mtlLoader.setPath('Assets/');
    mtlLoader.load( 'Chubby Monkey.mtl', function( materials )
    {
      materials.preload();

      var objLoader = new THREE.OBJLoader();

      objLoader.setMaterials( materials );
      objLoader.setPath('Assets/');
      objLoader.load( 'Chubby Monkey.obj', function ( object ) {

        model = object;

        model.traverse( function ( child )
        {
          if (child instanceof THREE.Mesh)
          {
            child.castShadow = true;
          }
        });

        wireframeModel = model.clone();

        wireframeModel.traverse( function ( child )
        {
          if ( child instanceof THREE.Mesh )
          {
            child.material = new THREE.MeshBasicMaterial( { color: 0xffffff, wireframe : true  }  );
          }
        } );

        Models.push(new ModelObject(model, materials, wireframeModel));

        scene.add(Models[0].Model);
      } );
    } );
  }

  function init() {
    //Updated clean code section
    closeSlideMenu();
    drawPlane(50, 50);
    addLight();
    setupCamera(0, 7, 15, 0.1, 10000);
    defaultSkybox();
    drawGrid(50, 50);
    loadDefaultModel();

    /* Events */
    window.addEventListener('resize', onWindowResize, false);
  }

  function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    render();
  }

  function render() {
    renderer.render(scene, camera);
  }

  /* GUI Functions */

  //SideBar Controls

  function loadNewModel() {

    var newModel = document.getElementById('NewModel').files[0];
    var modelURL = URL.createObjectURL( newModel );

    var newMaterial = document.getElementById('NewMaterial').files[0];
    var materialURL = URL.createObjectURL( newMaterial );

    var mtlLoader = new THREE.MTLLoader();
    mtlLoader.load(materialURL , function( materials )
    {
      materials.preload();

      var objLoader = new THREE.OBJLoader();

      objLoader.setMaterials( materials );
      objLoader.load(modelURL, function ( object ) {

        model = object;

        model.traverse( function ( child )
        {
          if (child instanceof THREE.Mesh)
          {
            child.castShadow = true;
          }
        });

        wireframeModel = model.clone();

        wireframeModel.traverse( function ( child )
        {
          if ( child instanceof THREE.Mesh )
          {
            child.material = new THREE.MeshBasicMaterial( { color: 0xffffff, wireframe : true  }  );
          }
        } );

        Models.push(new ModelObject(model, materials, wireframeModel));

        scene.add(Models[0].Wireframe);
      } );
    } );
  }

  function toggleAutoRotate () {
    controls.autoRotate = !controls.autoRotate;
  }

  function toggleCamReset () {
    controls.reset();
  }

  function addLight () {
    var light = new THREE.DirectionalLight(0xffe6b8, 1)
    light.name = "Directional Light";
    light.position.set(0,30,0);
    var target = new THREE.Object3D();
    target.position.set(0,0,0);
    light.target = target;
    scene.add(light.target);

    light.shadow.camera.left = -10;
    light.shadow.camera.right = 10;
    light.shadow.camera.top = 10;
    light.shadow.camera.bottom = -10;
    light.shadow.camera.near = 10;
    light.shadow.camera.far = 400;
    light.shadow.mapSize.width = 2048;
    light.shadow.mapSize.height = 2048;
    light.castShadow = true;

    //Create a helper for the shadow camera (optional)
    var helper = new THREE.CameraHelper( light.shadow.camera );

    ambient = new THREE.AmbientLight(0xffffff, 1.0);
    ambient.intensity = 0.5;
    //scene.add(helper);
    scene.add(ambient);
    scene.add(light);

    var newLi = document.createElement("li");
    var newA = document.createElement("a");
    var newContent = document.createTextNode(light.name);
    newA.appendChild(newContent);
    newLi.appendChild(newA);

    var parentLocation = document.getElementById("LightListTop");
    var insertLocation = document.getElementById("LightListBottom");
    parentLocation.insertBefore(newA, insertLocation);
  }

  function updateSkybox(){

    scene.remove(Skybox);

    var front = document.getElementById('NewFrontIMG').files[0];
    var frontURL = URL.createObjectURL( front );

    var back = document.getElementById('NewBackIMG').files[0];
    var backURL = URL.createObjectURL( back );

    var up = document.getElementById('NewUpIMG').files[0];
    var upURL = URL.createObjectURL( up );

    var down = document.getElementById('NewDownIMG').files[0];
    var downURL = URL.createObjectURL( down );

    var right = document.getElementById('NewRightIMG').files[0];
    var rightURL = URL.createObjectURL( right );

    var left = document.getElementById('NewLeftIMG').files[0];
    var leftURL = URL.createObjectURL( left );

    var skyboxGeometry = new THREE.CubeGeometry(10000, 10000, 10000);
    skyboxMaterials =
    [
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load(frontURL), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load(backURL), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load(upURL), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load(downURL), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load(rightURL), side: THREE.DoubleSide}),
      new THREE.MeshBasicMaterial ( { map: new THREE.TextureLoader().load(leftURL), side: THREE.DoubleSide})
    ];

    Skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterials);
    scene.add(Skybox);
  }

  /* HTML JavaScript Extensions */

  //Sliding Nav Bar
  function openSlideMenu() {
    document.getElementById('SettingsMenu').style.width = '250px';
    document.getElementById('SettingsMenu').style.fontSize = '100%';
    document.getElementById('SettingsMenu').style.opacity = '1';
    document.getElementById('SideBar').style.marginLeft = '250px';
    document.getElementById('Hamburger').style.opacity = '0';
  }
  function closeSlideMenu() {
    document.getElementById('SettingsMenu').style.width = '0px';
    document.getElementById('SettingsMenu').style.fontSize = '0%'
    document.getElementById('SettingsMenu').style.opacity = '0';
    document.getElementById('SideBar').style.marginLeft = '0px';
    document.getElementById('Hamburger').style.opacity = '1';
  }

  /* ColourPicker */
  $(function(){
      var bCanPreview = true; // can preview

      // create canvas and context objects
      var canvas = document.getElementById('picker');
      var ctx = canvas.getContext('2d');

      // drawing active image
      var image = new Image();
      image.onload = function () {
          ctx.drawImage(image, 0, 0, image.width, image.height); // draw the image on the canvas
      }

      // select desired colorwheel
      var imageSrc = 'Assets/ColourWheel.png';
      image.src = imageSrc;

      $('#picker').mousemove(function(e) { // mouse move handler
          if (bCanPreview) {
              // get coordinates of current position
              var canvasOffset = $(canvas).offset();
              var canvasX = Math.floor(e.pageX - canvasOffset.left);
              var canvasY = Math.floor(e.pageY - canvasOffset.top);

              // get current pixel
              var imageData = ctx.getImageData(canvasX, canvasY, 1, 1);
              var pixel = imageData.data;

              // update preview color
              var pixelColor = "rgb("+pixel[0]+", "+pixel[1]+", "+pixel[2]+")";
              $('.preview').css('backgroundColor', pixelColor);

              // update controls
              $('#rVal').val(pixel[0]);
              $('#gVal').val(pixel[1]);
              $('#bVal').val(pixel[2]);
              $('#rgbVal').val(pixel[0]+','+pixel[1]+','+pixel[2]);

              var dColor = pixel[2] + 256 * pixel[1] + 65536 * pixel[0];
              $('#hexVal').val('#' + ('0000' + dColor.toString(16)).substr(-6));
          }
      });
      $('#picker').click(function(e) { // click event handler
          bCanPreview = !bCanPreview;
      });
      $('.preview').click(function(e) { // preview click
          $('.colorpicker').fadeToggle("slow", "linear");
          bCanPreview = true;
      });
  });

  </script>
</body>
</html>
